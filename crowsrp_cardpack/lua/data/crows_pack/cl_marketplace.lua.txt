net.Receive("CrowsPack_SendMarketplace", function()
            local modelPreview = vgui.Create("DButton", cardPanel)
        modelPreview:SetText("üëÅ Preview")
        modelPreview:SetSize(80, 30)
        modelPreview:SetPos(490, 25)
        modelPreview.DoClick = function()
            CrowsPack_OpenModelPreview(item.card.model or "models/props_c17/oildrum001.mdl")
        end

        -- Rarity glow effect
        cardPanel.Paint = function(self, w, h)
            surface.SetDrawColor(0, 0, 0, 180)
            surface.DrawRect(0, 0, w, h)
            CrowsPack_DrawGlowAroundPanel(self, item.card.rarity)
        end

    local listings = net.ReadTable()

    local frame = vgui.Create("DFrame")
    frame:SetSize(700, 500)
    frame:Center()
    frame:SetTitle("Crows RP Marketplace")
    frame:MakePopup()

    local scroll = vgui.Create("DScrollPanel", frame)
    scroll:SetSize(680, 430)
    scroll:SetPos(10, 50)

    for k, item in pairs(listings) do
        local cardPanel = scroll:Add("DPanel")
        cardPanel:SetSize(660, 80)
        cardPanel:Dock(TOP)
        cardPanel:DockMargin(0, 0, 0, 10)

        local name = vgui.Create("DLabel", cardPanel)
        name:SetText(item.card.name .. " [" .. item.card.rarity .. "]")
        name:SetPos(10, 10)
        name:SizeToContents()

        local seller = vgui.Create("DLabel", cardPanel)
        seller:SetText("Seller: " .. item.name)
        seller:SetPos(10, 30)
        seller:SizeToContents()

        local price = vgui.Create("DLabel", cardPanel)
        price:SetText("Price: $" .. item.price)
        price:SetPos(10, 50)
        price:SizeToContents()

        local buy = vgui.Create("DButton", cardPanel)
        buy:SetText("Buy")
        buy:SetSize(60, 30)
        buy:SetPos(580, 25)
        buy.DoClick = function()
            net.Start("CrowsPack_BuyCard")
            net.WriteInt(k, 16)
            net.SendToServer()
            frame:Close()
        end
    end
end)

hook.Add("OnPlayerChat", "CrowsPack_MarketplaceCmd", function(ply, text)
    if text == "!marketplace" and ply == LocalPlayer() then
        net.Start("CrowsPack_OpenMarketplace")
        net.SendToServer()
        return true
    end
end)

net.Receive("CROWS_TCG_TokenUpdate", function()
    LocalPlayer().GoblinTokens = net.ReadInt(32)
end)

-- Request tokens when opening menu
hook.Add("CROWS_TCG_OpenMainMenu", "CROWS_TCG_RequestTokens", function()
    net.Start("CROWS_TCG_RequestTokenData")
    net.SendToServer()
end)

function CROWS_TCG_OpenMarketTab(parent)
    local panel = vgui.Create("DPanel", parent)
    panel:Dock(FILL)

    local tokens = LocalPlayer().GoblinTokens or 0

    local title = vgui.Create("DLabel", panel)
    title:SetFont("DermaLarge")
    title:SetText("Goblin Market - Tokens: " .. tokens)
    title:Dock(TOP)
    title:DockMargin(0, 10, 0, 20)
    title:SetContentAlignment(5)

    -- SELL CARDS
    local sellButton = vgui.Create("DButton", panel)
    sellButton:SetText("Sell Selected Card for Tokens")
    sellButton:Dock(TOP)
    sellButton:DockMargin(10, 5, 10, 5)
    sellButton.DoClick = function()
        local card = CROWS_TCG_SelectedCard
        if not card then chat.AddText("[Goblin] You must select a card first!") return end

        net.Start("CROWS_TCG_SellCard")
            net.WriteString(card.uid)
        net.SendToServer()
    end

    -- BUY PACKS
    local packButton = vgui.Create("DButton", panel)
    packButton:SetText("Buy 1 Card Pack (50 Tokens)")
    packButton:Dock(TOP)
    packButton:DockMargin(10, 5, 10, 5)
    packButton.DoClick = function()
        net.Start("CROWS_TCG_BuyPack")
        net.SendToServer()
    end

    return panel
end

